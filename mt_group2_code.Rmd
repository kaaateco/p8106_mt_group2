---
title: "P8106 Midterm - Code"
author: "Group 2: Kate Colvin (KAC2301), Jeong Yun (Lizy) Choi (JC6452), and"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gtsummary)
library(gt)
library(corrplot)
```

# Exploratory Analysis 

### Loading in Data

```{r}

load("dat1.RData") 
load("dat2.RData")

dat1 <- dat1 %>% janitor::clean_names()
dat2 <- dat2 %>%janitor::clean_names()

```

### Producing Summary Table

Notes

Training and test data have the same distribution of demographic characteristics; there is a difference in time since vaccination and log-transformed antibody levels between training and test data

```{r}

# Combining data for summary table, data cleaning
dat1_com <- dat1 %>% mutate(set = "Training Data")
dat2_com <- dat2 %>% mutate(set = "Testing Data")

dat <- dat1_com %>% 
  rbind(dat2_com) %>% 
  rename(days_vaccinated = time) %>% 
  mutate(race = as.character(race), 
         smoking = as.character(smoking)) %>% 
  mutate(race = case_match(
        race, 
           "1" ~ "White",
           "2" ~ "Asian", 
           "3" ~ "Black", 
           "4" ~ "Hispanic"),
         gender = case_match(
           gender, 
           1 ~ "Male", 
           0 ~ "Female"), 
         smoking = case_match(
           smoking, 
           "0" ~ "Never", 
           "1" ~ "Former", 
           "2" ~ "Current"))

# Summary table
dat %>% select(!id) %>% 
  tbl_summary(
    by = set, 
    label = list(age = "Age", 
                 gender = "Gender", 
                 race = "Race", 
                 smoking = "Smoking", 
                 height = "Height (cm)", 
                 weight = "Weight (kg)", 
                 bmi = "BMI", 
                 diabetes = "Diabetes", 
                 hypertension = "Hypertension", 
                 sbp = "Systolic Blood Pressure (mmHg)", 
                 ldl = "LDL Cholesterol (mg/dL)", 
                 days_vaccinated = "Time Since Vaccinated (days)", 
                 log_antibody = "Log-Transformed Antibody Level")) %>% 
  add_overall() %>% 
  add_p() %>% 
  modify_caption("Summary of Patient Testing and Training Data (N=6000)") %>% 
  as_gt() %>% 
  tab_options(table.font.size = 10)

```


### Histograms of Differing Variables by Training and Test Set

```{r}

# Antibody level 
plot_sets <- dat %>%  
  ggplot(aes(x = log_antibody, fill = set, color = set)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  labs(x = "Log-Transformed Antibody Level", y = "Density") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5))
plot_sets


# Time since vaccination (days)
plot_days <- dat %>%  
  ggplot(aes(x = days_vaccinated, fill = set, color = set)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  labs(x = "Time Since Vaccinated (days)", y = "Density") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5))

plot_days

```


### Plots of Log(Antibody), by Categorical Variables

```{r}

# Antibody level, by gender 
plot_gender <- dat %>%  
  ggplot(aes(x = log_antibody, fill = gender, color = gender)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  labs(x = "Log-Transformed Antibody Level", y = "Density") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5))
plot_gender

dat %>% select(gender, log_antibody) %>% 
  tbl_summary(by = gender) %>% 
    add_p() %>% 
    add_overall() %>% 
  modify_caption("Log-Transformed Antibody Level, by Gender") %>% 
  as_gt() %>% 
  tab_options(table.font.size = 10)

```

```{r}

# Antibody level, by race
plot_race <- dat %>%  
  ggplot(aes(x = log_antibody, fill = race, color = race)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  labs(x = "Log-Transformed Antibody Level", y = "Density") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5))
plot_race

dat %>% select(race, log_antibody) %>% 
  tbl_summary(by = race) %>% 
    add_p() %>% 
    add_overall() %>% 
  modify_caption("Log-Transformed Antibody Level, by Race") %>% 
  as_gt() %>% 
  tab_options(table.font.size = 8)

```

```{r}

# Antibody level, by smoking status 
plot_smoking <- dat %>%  
  ggplot(aes(x = log_antibody, fill = smoking, color = smoking)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  labs(x = "Log-Transformed Antibody Level", y = "Density") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5))
plot_smoking

dat %>% select(smoking, log_antibody) %>% 
  tbl_summary(by = smoking) %>% 
    add_p() %>% 
    add_overall() %>% 
  modify_caption("Log-Transformed Antibody Level, by Smoking Status") %>% 
  as_gt() %>% 
  tab_options(table.font.size = 10)

```


### Correlation Matrix of Numerical Variables 

Potentially will try to reorder axes but idk why its not going lol !

```{r, warning=FALSE}

cor_matrix <- dat %>% 
  select(age, height, weight, bmi, sbp, ldl, days_vaccinated, log_antibody) %>% 
  rename("Age" = age, 
         "Height" = height,
         "Weight" = weight,
         "BMI" = bmi,
         "SBP" = sbp, 
         "LDL" = ldl,
         "Days Vaccinated" = days_vaccinated, 
         "Log(Antibody)" = log_antibody) %>% 
  cor()

cor_plot <- corrplot(cor_matrix,  method = "color", 
         addCoef.col = "black", 
         tl.col = "black",      
         tl.srt = 45,
         order = 'hclust',
         diag = F)

```


### Plots of Log(Antibody) vs. Selected Numerical Variables

Not sure how I feel about these lol

```{r, message=FALSE}

# Antibody level vs. BMI
plot_bmi <- dat %>%  
  ggplot(aes(x = bmi, y = log_antibody, fill = set, color = set)) +
  geom_point(alpha = 0.3, size = 2) +
  geom_smooth(method = "lm") +
  labs(y = "Log-Transformed Antibody Level", x = "BMI") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5))
plot_bmi


# Antibody level vs. Weight
plot_weight <- dat %>%  
  ggplot(aes(x = weight, y = log_antibody, fill = set, color = set)) +
  geom_point(alpha = 0.3, size = 2) +
  geom_smooth(method = "lm") +
  labs(y = "Log-Transformed Antibody Level", x = "Weight") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5))
plot_weight


# Antibody level vs. Age
plot_age <- dat %>%  
  ggplot(aes(x = age, y = log_antibody, fill = set, color = set)) +
  geom_point(alpha = 0.3, size = 2) +
  geom_smooth(method = "lm") +
  labs(y = "Log-Transformed Antibody Level", x = "Age") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5))
plot_age

```


# Model Training

```{r}


```



# Results

```{r}

```

