---
title: "P8106 Midterm - Code"
author: "Group 2: Kate Colvin (KAC2301), Jeong Yun (Lizy) Choi (JC6452), and Flora Pang (FP2513)"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gtsummary)
library(gt)
library(corrplot)
library(kableExtra)

library(caret)
library(glmnet) 
library(earth) 
```

# Exploratory Analysis 

### Loading in Data

```{r}

load("dat1.RData") 
load("dat2.RData")

dat1 <- dat1 %>% janitor::clean_names()
dat2 <- dat2 %>%janitor::clean_names()

```

### Producing Summary Table

Training and test data have the same distribution of demographic characteristics; there is a difference in time since vaccination and log-transformed antibody levels between training and test data

```{r}

# Combining data for summary table, data cleaning
dat1_com <- dat1 %>% mutate(set = "Training Data")
dat2_com <- dat2 %>% mutate(set = "Testing Data")

dat <- dat1_com %>% 
  rbind(dat2_com) %>% 
  rename(days_vaccinated = time) %>% 
  mutate(race = as.character(race), smoking = as.character(smoking)) %>% 
  mutate(race = case_match(
        race, "1" ~ "White", "2" ~ "Asian", "3" ~ "Black", "4" ~ "Hispanic"),
         gender = case_match(gender, 1 ~ "Male", 0 ~ "Female"), 
         smoking = case_match(
           smoking, "0" ~ "Never", "1" ~ "Former", "2" ~ "Current"))

# Summary table
dat %>% select(!id) %>% 
  tbl_summary(
    by = set, 
    label = list(age = "Age", gender = "Gender", race = "Race", smoking = "Smoking", 
                 height = "Height (cm)", weight = "Weight (kg)", bmi = "BMI", 
                 diabetes = "Diabetes", hypertension = "Hypertension", 
                 sbp = "Systolic Blood Pressure (mmHg)", ldl = "LDL Cholesterol (mg/dL)", 
                 days_vaccinated = "Time Since Vaccinated (days)", 
                 log_antibody = "Log-Transformed Antibody Level")) %>% 
  add_overall() %>% add_p() %>% 
  modify_caption("Summary of Patient Testing and Training Data (N=6000)") %>% 
  as_gt() %>% tab_options(table.font.size = 10)

```


### Histograms of Differing Variables by Training and Test Set

```{r, out.width = "95%", fig.align = "center"}

# Antibody level 
plot_sets <- dat %>%  
  ggplot(aes(x = log_antibody, 
             fill = set, 
             color = set)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  labs(x = "Log-Transformed Antibody Level", 
       y = "Density", 
       title = "Figure 1: Distribution of Log-Transformed Antibody Level, by Data Set") +
  theme_minimal()

# Time since vaccination (days)
plot_days <- dat %>%  
  ggplot(aes(x = days_vaccinated, 
             fill = set, 
             color = set)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  labs(x = "Time Since Vaccinated (days)", 
       y = "Density", 
       title = "Figure 2: Distribution of Days Since Vaccination, by Data Set") +
  theme_minimal()

plot_sets
plot_days

```


### Plots of Log-Transformed Antibody Level, by Categorical Variables

```{r, out.width = "100%", fig.align = "center"}
# Antibody level, by gender
plot_gender <- dat %>%  
  ggplot(aes(x = log_antibody, fill = gender, color = gender)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  labs(x = "Log-Transformed Antibody Level", y = "Density", 
       title = "Figure 3: Distribution of Log-Transformed Antibody Level, by Gender") +
  theme_minimal()
plot_gender

strip_markdown <- function(x) {gsub("\\*\\*", "", x)}

dat %>% select(gender, log_antibody) %>% 
  tbl_summary(by = gender) %>% add_p() %>% 
  modify_caption("Log-Transformed Antibody Level, by Gender") %>% 
  as_kable() %>% 
  footnote(general_title = "", general = "Median (Q1, Q3), Wilcoxon Rank Sum Test") %>% 
  strip_markdown()

```



```{r}
# Antibody level, by race
plot_race <- dat %>%  
  ggplot(aes(x = log_antibody, fill = race, color = race)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  labs(x = "Log-Transformed Antibody Level", 
       y = "Density", 
       title = "Figure 4: Distribution of Log-Transformed Antibody Level, by Race") +
  theme_minimal()

plot_race

dat %>% 
  select(race, log_antibody) %>% 
  tbl_summary(by = race) %>% 
    add_p() %>% 
  modify_caption("Log-Transformed Antibody Level, by Race") %>% 
  as_kable() %>% 
  footnote(general_title = "", 
           general = "Median (Q1, Q3), Kruskal-Wallis Rank Sum Test") %>% 
  strip_markdown()

```

```{r}
# Antibody level, by smoking status 
plot_smoking <- dat %>%  
  ggplot(aes(x = log_antibody, fill = smoking, color = smoking)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  labs(x = "Log-Transformed Antibody Level", 
       y = "Density", 
       title = "Figure 5: Distribution of Log-Transformed Antibody Level, by Smoking") +
  theme_minimal()
plot_smoking

dat %>% select(smoking, log_antibody) %>% 
  tbl_summary(by = smoking) %>% 
    add_p() %>% 
  modify_caption("Log-Transformed Antibody Level, by Smoking Status") %>% 
  as_kable() %>% 
  footnote(general_title = "", 
           general = "Median (Q1, Q3), Kruskal-Wallis Rank Sum Test") %>% 
  strip_markdown()

```


### Correlation Matrix of Numerical Variables 

```{r, warning=FALSE}

cor_matrix <- dat %>% 
  select(age, height, weight, bmi, sbp, ldl, days_vaccinated, log_antibody) %>% 
  rename("Age" = age, 
         "Height" = height,
         "Weight" = weight,
         "BMI" = bmi,
         "SBP" = sbp, 
         "LDL" = ldl,
         "Days Vaccinated" = days_vaccinated, 
         "Log(Antibody)" = log_antibody) %>% 
  cor()

cor_plot <- corrplot(cor_matrix,  
                     main = "Figure 6: Correlation Matrix of Numerical Variables", 
                     mar=c(0,0,1,0), cex.main = 1,
                     method = "color", 
                     addCoef.col = "black", 
                     tl.col = "black", 
                     number.cex = 0.8, 
                     tl.srt = 45, 
                     order = 'original', 
                     diag = F)

```

\newpage

### Plots of Log-Transformed Antibody Level vs. Selected Numerical Variables

```{r, message=FALSE, out.width="90%", fig.align = "center"}
# Antibody level vs. BMI
plot_bmi <- dat %>% ggplot(aes(x = bmi, y = log_antibody, fill = set, color = set)) +
  geom_point(alpha = 0.3, size = 2) +
  geom_smooth(method = "lm") +
  labs(y = "Log-Transformed Antibody Level", x = "BMI", 
       title = "Figure 7: Log-Transformed Antibody Level vs. BMI") +
  theme_minimal()

# Antibody level vs. Weight
plot_weight <- dat %>% 
  ggplot(aes(x = weight, y = log_antibody, fill = set, color = set)) +
  geom_point(alpha = 0.3, size = 2) +
  geom_smooth(method = "lm") +
  labs(y = "Log-Transformed Antibody Level", x = "Weight", 
       title = "Figure 8: Log-Transformed Antibody Level vs. Weight") +
  theme_minimal()

# Antibody level vs. Age
plot_age <- dat %>% ggplot(aes(x = age, y = log_antibody, fill = set, color = set)) +
  geom_point(alpha = 0.3, size = 2) + geom_smooth(method = "lm") +
  labs(y = "Log-Transformed Antibody Level", x = "Age", 
       title = "Figure 9: Log-Transformed Antibody Level vs. Age") +
  theme_minimal()

plot_bmi
plot_weight
plot_age

```


\newpage

# Model Training

Since the response variable (log_antibody) is continuous, this project will consider the following models:

* Multiple Linear Regression (MLR) - as a baseline.

* LASSO Regression – to improve predictive performance by selecting important predictors.

* Random Forest Regression – to capture nonlinear relationships.

After comparing model performance, the best model will be based on cross-validation results.

## Data Pre-processing

```{r}
# Converting categorical variables into factors
dat1 <- dat1 %>%
  mutate(
    gender = factor(gender, levels = c(0, 1), labels = c("Female", "Male")),
    race = factor(race, levels = c(1, 2, 3, 4), labels = c("White", "Asian", "Black", "Hispanic")),
    smoking = factor(smoking, levels = c(0, 1, 2), labels = c("Never", "Former", "Current")),
    diabetes = factor(diabetes),
    hypertension = factor(hypertension)
  )

dat2 <- dat2 %>%
  mutate(
    gender = factor(gender, levels = c(0, 1), labels = c("Female", "Male")),
    race = factor(race, levels = c(1, 2, 3, 4), labels = c("White", "Asian", "Black", "Hispanic")),
    smoking = factor(smoking, levels = c(0, 1, 2), labels = c("Never", "Former", "Current")),
    diabetes = factor(diabetes),
    hypertension = factor(hypertension)
  )

```

```{r}
sum(is.na(dat1))
sum(is.na(dat2))
```

```{r}
dat1 <- dat1 %>% select(-id)
dat2 <- dat2 %>% select(-id)
```

```{r}
# Split training data into training (80%) and validation (20%)
set.seed(123)
train_index <- createDataPartition(dat1$log_antibody, p = 0.8, list = FALSE)
train_data <- dat1[train_index, ]
valid_data <- dat1[-train_index, ]
```


## Training multiple linear regression model 

```{r}
mlr_model <- lm(log_antibody ~ ., data = train_data)
summary(mlr_model)
```


```{r}
# Evaluating model performance on validation data
mlr_pred <- predict(mlr_model, newdata = valid_data)
mlr_rmse <- sqrt(mean((mlr_pred - valid_data$log_antibody)^2))
mlr_rmse
```

## Training LASSO regression model

### Standardizing numerical variables for LASSO 

```{r}
num_vars <- c("age", "height", "weight", "bmi", "sbp", "ldl", "time")

preprocess_params <- preProcess(train_data[, num_vars], method = c("center", "scale"))
train_data[, num_vars] <- predict(preprocess_params, train_data[, num_vars])
valid_data[, num_vars] <- predict(preprocess_params, valid_data[, num_vars])
dat2[, num_vars] <- predict(preprocess_params, dat2[, num_vars]) # Applying same transformation to test data
```

```{r}
# Preparing the data matrices for glmnet
x_train <- model.matrix(log_antibody ~ ., train_data)[, -1]  # Removing the intercept
y_train <- train_data$log_antibody

x_valid <- model.matrix(log_antibody ~ ., valid_data)[, -1]
y_valid <- valid_data$log_antibody
```

```{r}
set.seed(123)
lasso_model <- cv.glmnet(x_train, y_train, alpha = 1) # LASSO with cross validation

best_lambda <- lasso_model$lambda.min
lasso_final <- glmnet(x_train, y_train, alpha = 1, lambda = best_lambda) # final model is based on optimal lambda
```

```{r}
# predicting with LASSO on validation data

lasso_pred <- predict(lasso_final, newx = x_valid)
lasso_rmse <- sqrt(mean((lasso_pred - y_valid)^2))
lasso_rmse
```


\newpage

# Results

```{r}

```

